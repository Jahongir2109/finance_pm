{% extends "layout.html" %}
{% block body %}

<div class="card mb-3">
    <div class="action-item d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <i class="bi bi-wallet"></i>
            <strong>Accounts</strong>
        </div>
        <button id="addAccountBtn" type="button" class="btn btn-primary">+</button>
    </div>
</div>

<table class="table">
    <tbody>
        {% for a in accounts %}
        <tr class="account-row" data-id="{{ a.id }}" data-name="{{ a.name }}" data-balance="{{ a.balance }}"
            data-currency="{{ a.currencyId }}" style="cursor:pointer">
            <td>{{ a.name }}</td>
            <td>{{ "%.2f"|format(a.balance) }} {{ a.currency }}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="{{ a.id }}">
                    Delete
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ADD ACCOUNT MODAL -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{{ url_for('accounts') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input name="name" class="form-control mb-2" placeholder="Name" required>
                    <input name="balance" type="number" step="0.01" class="form-control mb-2" required>
                    <select name="currency" id="currencySelect" class="form-select" required>
                        {% for c in currencies %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                        <option value="add"><a href="{{ url_for('currencies') }}">Add new currency</a></option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                    <button class="btn btn-success">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EDIT ACCOUNT MODAL -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editAccountForm">
                <input type="hidden" id="editId">

                <div class="modal-header">
                    <h5 class="modal-title">Edit account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input id="editName" class="form-control mb-2" required>
                    <input id="editBalance" type="number" step="0.01" class="form-control mb-2" required>
                    <select id="currencySelect" class="form-select">
                        {% for c in currencies %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                        <option value="add">>Add new currency</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="saveEditBtn" type="button" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const addModal = new bootstrap.Modal(document.getElementById('addAccountModal'));
        const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));

        document.getElementById('addAccountBtn').onclick = () => addModal.show();

        document.querySelectorAll('.account-row').forEach(row => {
            row.onclick = () => {
                editId.value = row.dataset.id;
                editName.value = row.dataset.name;
                editBalance.value = row.dataset.balance;
                editCurrency.value = row.dataset.currency;
                editModal.show();
            };
        });

        saveEditBtn.onclick = async () => {
            const payload = {
                id: editId.value,
                name: editName.value,
                balance: editBalance.value,
                currency: editCurrency.value
            };

            const res = await fetch("{{ url_for('accounts') }}", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                credentials: "same-origin"
            });

            res.ok ? location.reload() : alert("Update failed");
        };

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = async e => {
                e.stopPropagation();
                if (!confirm("Delete account?")) return;

                const res = await fetch("{{ url_for('accounts') }}", {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: btn.dataset.id }),
                    credentials: "same-origin"
                });

                res.ok ? location.reload() : alert("Delete failed");
            };
        });

        document.getElementById("currencySelect").onchange = function () {
            if (this.value === "add") {
                window.location = "{{ url_for('currencies') }}";
            }
        };
    });
</script>

{% endblock %}