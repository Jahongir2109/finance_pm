{% extends "layout.html" %}
{% block body %}
<div class="card mb-3">
    <div class="action-item d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <i class="bi bi-wallet"></i>
            <strong>Currencies</strong>
        </div>
        <button id="addCurrencyBtn" type="button" class="btn btn-primary">+</button>
    </div>
</div>

<table class="table">
    <tbody>
        {% for c in currencies %}
        <tr class="currency-row" data-id="{{ c.id }}" data-name="{{ c.name }}" data-short="{{ c.shortName }}"
            style="cursor:pointer">
            <td>{{ c.shortName }}</td>
            <td>{{ c.name }}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="{{ c.id }}"
                    aria-label="Delete {{ c.shortName }}">
                    Delete
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Add modal (POST) -->
<div class="modal fade" id="addCurrencyModal" tabindex="-1" aria-labelledby="addCurrencyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addCurrencyForm" method="post" action="{{ url_for('currencies') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCurrencyModalLabel">Add currency</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addName" class="form-label">Name</label>
                        <input id="addName" name="name" class="form-control" required placeholder="e.g. US Dollar">
                    </div>
                    <div class="mb-3">
                        <label for="addShortName" class="form-label">Short Name</label>
                        <input id="addShortName" name="shortName" class="form-control" required maxlength="5"
                            placeholder="e.g. USD">
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-outline-secondary" href="{{ url_for('accounts') }}">Back to accounts</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit modal (PUT) -->
<div class="modal fade" id="editCurrencyModal" tabindex="-1" aria-labelledby="editCurrencyModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- keep method POST only for progressive enhancement; JS will send PUT -->
            <form id="editCurrencyForm" method="post" action="{{ url_for('currencies') }}">
                <input type="hidden" name="id" id="editCurrencyId" value="">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCurrencyModalLabel">Edit currency</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editShortName" class="form-label">Short Name</label>
                        <input id="editShortName" name="shortName" class="form-control" required maxlength="5"
                            placeholder="e.g. USD">
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">Name</label>
                        <input id="editName" name="name" class="form-control" required placeholder="e.g. US Dollar">
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-outline-secondary" href="{{ url_for('accounts') }}">Back to accounts</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <!-- Make this a button so default form POST is prevented and we control behavior -->
                    <button id="editSaveBtn" type="button" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // require bootstrap.bundle.js in layout.html
        const addModalEl = document.getElementById('addCurrencyModal');
        const editModalEl = document.getElementById('editCurrencyModal');
        const addModal = addModalEl ? new bootstrap.Modal(addModalEl) : null;
        const editModal = editModalEl ? new bootstrap.Modal(editModalEl) : null;

        // add button
        const addBtn = document.getElementById('addCurrencyBtn');
        if (addBtn && addModal) addBtn.addEventListener('click', () => addModal.show());

        // row click -> open edit modal and populate fields
        document.querySelectorAll('.currency-row').forEach(row => {
            row.addEventListener('click', () => {
                const id = row.dataset.id || '';
                const name = row.dataset.name || '';
                const short = row.dataset.short || '';

                document.getElementById('editCurrencyId').value = id;
                document.getElementById('editName').value = name;
                document.getElementById('editShortName').value = short;

                if (editModal) editModal.show();
            });

            // keyboard support
            row.tabIndex = 0;
            row.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    row.click();
                }
            });
        });

        // edit save -> send PUT via fetch
        const editSaveBtn = document.getElementById('editSaveBtn');
        if (editSaveBtn) {
            editSaveBtn.addEventListener('click', async () => {
                const id = document.getElementById('editCurrencyId').value.trim();
                const name = document.getElementById('editName').value.trim();
                const shortName = document.getElementById('editShortName').value.trim();
                if (!id) return alert('Missing id');
                try {
                    const res = await fetch("{{ url_for('currencies') }}", {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id, name, shortName }),
                        credentials: 'same-origin'
                    });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const text = await res.text();
                        console.error('PUT failed', res.status, text);
                        alert('Update failed');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Network error');
                }
            });
        }
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation(); // prevent opening edit modal
                const id = btn.dataset.id;
                if (!id) return;
                if (!confirm('Delete this currency?')) return;

                btn.disabled = true;
                try {
                    const res = await fetch("{{ url_for('currencies') }}", {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id }),
                        credentials: 'same-origin',
                        redirect: 'manual'
                    });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const text = await res.text();
                        console.error('DELETE failed', res.status, text);
                        alert('Delete failed');
                    }
                } catch (err) {
                    console.error('DELETE error', err);
                    alert('Network error');
                } finally {
                    btn.disabled = false;
                }
            });
        });

    });
</script>
{% endblock %}